
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Dashboard</title>
    <script async src="https://scripts.simpleanalyticscdn.com/latest.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .grab-handle {
            cursor: move;
            user-select: none;
            /* Prevent text selection */
        }
    </style>
</head>

<body>
    <div class="flex flex-col h-screen">
        <!-- Fixed Header -->
        <header class="flex items-center p-4 fixed w-full top-0 z-100 bg-white">
            <div class="text-lg font-bold">
                <img src="https://res.cloudinary.com/auuscloud/image/upload/v1742318027/jaira_gziy01.png"
                     class="h-[40px] w-auto mx-auto" />
            </div>
            <div class="sm:text-2xl font-bold text-gray-800 fixed mt-2 pl-[220px]" id="current-menu">Project</div>
        </header>

        <!-- Main Content -->
        <div class="flex flex-grow mt-16">
            <!-- Sidebar Menu -->
            <div class="w-1/6 bg-gray-100 shadow-md p-4 min-w-[200px]">
                <ul id="menu" class="space-y-2">
                    <li class="menu-item p-2 cursor-pointer bg-gray-200" data-target="project">Project</li>
                    <li class="menu-item p-2 cursor-pointer" data-target="gantt">Gantt</li>
                    <li class="menu-item p-2 cursor-pointer" data-target="kanban">KanBan</li>
                </ul>
                <!-- Project Filter -->
                <div class="pt-4 pb-4 border-t border-white border-t-2 ">
                    <div class="flex flex-wrap gap-2 mb-4" id="project-filters">
                        <!-- Project filter buttons will be added here dynamically -->
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="w-5/6 p-4">
                <!-- Project Area -->
                <div id="project" class="content hidden">

                    <div class="bg-white-100 p-4">

                        <div class="max-w-7xl mx-auto">

                            <!-- Add New Task Button -->
                            <div class="mb-4">
                                <button id="add-task"
                                        class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md">
                                    Add New Task
                                </button>
                            </div>

                            <!-- Table Container -->
                            <div class="overflow-x-auto bg-white rounded-lg shadow">
                                <table class="min-w-full">
                                    <thead>
                                        <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                            <th class="py-3 px-4">
                                                <span class="sort-indicator" id="grabber">▲</span>
                                            </th>
                                            <th class="py-3 px-4 text-left cursor-pointer" data-sort="urgency">
                                                Urgency <span class="sort-indicator" id="urgency-indicator">▲</span>
                                            </th>
                                            <th class="py-3 px-4 text-left cursor-pointer" data-sort="project">
                                                Project <span class="sort-indicator" id="project-indicator"></span>
                                            </th>
                                            <th class="py-3 px-4 text-left">Status</th>
                                            <th class="py-3 px-4 text-left cursor-pointer" data-sort="ticket">
                                                Ticket <span class="sort-indicator" id="ticket-indicator"></span>
                                            </th>
                                            <th class="py-3 px-4 text-left cursor-pointer" data-sort="startdate">
                                                Start Date <span class="sort-indicator" id="startdate-indicator"></span>
                                            </th>
                                            <th class="py-3 px-4 text-left cursor-pointer" data-sort="duedate">
                                                Due Date <span class="sort-indicator" id="duedate-indicator"></span>
                                            </th>
                                            <th class="py-3 px-4 text-left cursor-pointer" data-sort="enddate">
                                                End Date <span class="sort-indicator" id="enddate-indicator"></span>
                                            </th>
                                            <th class="py-3 px-4 text-left cursor-pointer" data-sort="resource">
                                                Resource <span class="sort-indicator" id="resource-indicator"></span>
                                            </th>
                                            <th class="py-3 px-4 text-left">Comments</th>
                                            <th class="py-3 px-4 text-left"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="task-table-body" class="text-sm">
                                        <!-- Table rows will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Edit Task Modal -->
                        <div id="edit-modal"
                             class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
                            <div class="bg-white rounded-lg p-6 w-full max-w-4xl max-h-screen overflow-y-auto">
                                <h2 id="modal-title" class="text-xl font-bold mb-4">Add New Task</h2>
                                <form id="task-form" class="space-y-4">
                                    <input type="hidden" id="edit-task-id">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Urgency:</label>
                                            <input type="number" id="edit-urgency"
                                                   class="w-full px-3 py-2 border rounded-md" readonly>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Project:</label>
                                            <input type="text" id="edit-project"
                                                   class="w-full px-3 py-2 border rounded-md" required>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Status:</label>
                                            <div class="flex space-x-4">
                                                <label class="inline-flex items-center">
                                                    <input type="radio" name="status" value="red" class="form-radio">
                                                    <span class="ml-2">Red</span>
                                                </label>
                                                <label class="inline-flex items-center">
                                                    <input type="radio" name="status" value="amber" class="form-radio">
                                                    <span class="ml-2">Amber</span>
                                                </label>
                                                <label class="inline-flex items-center">
                                                    <input type="radio" name="status" value="green" class="form-radio">
                                                    <span class="ml-2">Green</span>
                                                </label>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Ticket:</label>
                                            <input type="text" id="edit-ticket"
                                                   class="w-full px-3 py-2 border rounded-md">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                                Start
                                                Date:
                                            </label>
                                            <input type="date" id="edit-startdate"
                                                   class="w-full px-3 py-2 border rounded-md">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                                Due
                                                Date:
                                            </label>
                                            <input type="date" id="edit-duedate"
                                                   class="w-full px-3 py-2 border rounded-md">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                                End
                                                Date:
                                            </label>
                                            <input type="date" id="edit-enddate"
                                                   class="w-full px-3 py-2 border rounded-md">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Resource:</label>
                                            <input type="text" id="edit-resource"
                                                   class="w-full px-3 py-2 border rounded-md">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Comments:</label>
                                        <textarea id="edit-comments"
                                                  class="w-full px-3 py-2 border rounded-md h-32"></textarea>
                                    </div>
                                    <div class="flex justify-end space-x-3">
                                        <button type="button" id="cancel-edit"
                                                class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-md">
                                            Cancel
                                        </button>
                                        <button type="submit"
                                                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md">
                                            Save
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <script>
                            // Sample data (will be overridden by localStorage if available)
                            let tasks = [
                                {
                                    id: 1,
                                    urgency: 1,
                                    project: "Website Redesign",
                                    status: "amber",
                                    ticket: "PROJ-101",
                                    startdate: "2025-03-10",
                                    duedate: "2025-04-15",
                                    enddate: "",
                                    resource: "John Smith",
                                    comments: "Initial design phase completed, waiting for client feedback."
                                },
                                {
                                    id: 2,
                                    urgency: 2,
                                    project: "Database Migration",
                                    status: "red",
                                    ticket: "PROJ-205",
                                    startdate: "2025-03-05",
                                    duedate: "2025-03-20",
                                    enddate: "",
                                    resource: "Jane Doe",
                                    comments: "Critical issues with data mapping. Need urgent attention."
                                },
                                {
                                    id: 3,
                                    urgency: 3,
                                    project: "Mobile App Updates",
                                    status: "green",
                                    ticket: "PROJ-310",
                                    startdate: "2025-03-15",
                                    duedate: "2025-04-10",
                                    enddate: "2025-04-05",
                                    resource: "Mike Johnson",
                                    comments: "On track, all features implemented ahead of schedule."
                                },
                                {
                                    id: 4,
                                    urgency: 4,
                                    project: "Website Redesign",
                                    status: "green",
                                    ticket: "PROJ-102",
                                    startdate: "2025-03-20",
                                    duedate: "2025-04-20",
                                    enddate: "",
                                    resource: "Sarah Lee",
                                    comments: "Backend integration planning in progress."
                                }
                            ];

                            // Check and set tasks in localStorage if not already set
                            if (!localStorage.getItem("ppms_tasks")) {
                                localStorage.setItem("ppms_tasks", JSON.stringify(tasks));
                            }

                            // DOM elements
                            const taskTableBody = document.getElementById('task-table-body');
                            const projectFilters = document.getElementById('project-filters');
                            const editModal = document.getElementById('edit-modal');
                            const taskForm = document.getElementById('task-form');
                            const modalTitle = document.getElementById('modal-title');
                            const addTaskBtn = document.getElementById('add-task');
                            const cancelEditBtn = document.getElementById('cancel-edit');

                            // Current sort state
                            let currentSort = {
                                column: 'urgency',
                                direction: 'asc'
                            };

                            // Current filter
                            let currentFilter = localStorage.getItem("last_selected_project");
                            if (!currentFilter) {
                                currentFilter = 'all';
                            };

                            // Load tasks from localStorage
                            function loadTasksFromStorage() {
                                const storedTasks = localStorage.getItem('ppms_tasks');
                                if (storedTasks) {
                                    tasks = JSON.parse(storedTasks);
                                }
                            }

                            // Save tasks to localStorage
                            function saveTasksToStorage() {
                                localStorage.setItem('ppms_tasks', JSON.stringify(tasks));
                            }

                            // Initialize the application
                            document.addEventListener('DOMContentLoaded', function () {
                                loadTasksFromStorage();
                                renderTasks();
                                setupProjectFilters();
                                setupSortableTable();
                                setupEventListeners();
                            });


                            // Render tasks to the table
                            function renderTasks() {
                                // Clear the table
                                taskTableBody.innerHTML = '';

                                // Filter tasks if needed
                                let filteredTasks = tasks;
                                if (currentFilter !== 'all') {
                                    filteredTasks = tasks.filter(task => task.project === currentFilter);
                                }

                                // Sort tasks
                                filteredTasks.sort((a, b) => {
                                    let valueA = a[currentSort.column];
                                    let valueB = b[currentSort.column];

                                    // Handle dates
                                    if (['startdate', 'duedate', 'enddate'].includes(currentSort.column)) {
                                        valueA = valueA ? new Date(valueA).getTime() : 0;
                                        valueB = valueB ? new Date(valueB).getTime() : 0;
                                    }

                                    if (currentSort.direction === 'asc') {
                                        return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
                                    } else {
                                        return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
                                    }
                                });

                                // Update sort indicators
                                updateSortIndicators();

                                // Add rows to the table
                                filteredTasks.forEach(task => {
                                    const row = document.createElement('tr');
                                    row.setAttribute('data-id', task.id);
                                    row.className = 'border-b hover:bg-gray-100';

                                    // Set row background based on status
                                    if (task.status === 'red') {
                                        row.classList.add('bg-red-100');
                                    } else if (task.status === 'amber') {
                                        row.classList.add('bg-yellow-100');
                                    } else if (task.status === 'green') {
                                        row.classList.add('bg-green-100');
                                    }

                                    // Add a grab handle to the row
                                    row.innerHTML = `
                                              <td class="py-2 px-4">
                                                  <div class="grab-handle cursor-move">☰</div>
                                              </td>
                                              <td class="py-2 px-4">${task.urgency}</td>
                                              <td class="py-2 px-4">${task.project}</td>
                                              <td class="py-2 px-4">
                                                  <div class="flex items-center">
                                                      <span class="w-3 h-3 rounded-full ${getStatusColor(task.status)} mr-2"></span>
                                                      ${capitalizeFirstLetter(task.status)}
                                                  </div>
                                              </td>
                                              <td class="py-2 px-4">${task.ticket}</td>
                                              <td class="py-2 px-4">${formatDate(task.startdate)}</td>
                                              <td class="py-2 px-4">${formatDate(task.duedate)}</td>
                                              <td class="py-2 px-4">${formatDate(task.enddate)}</td>
                                              <td class="py-2 px-4">${task.resource}</td>
                                              <td class="py-2 px-4">
                                                  <div class="max-h-20 overflow-y-auto text-sm">${task.comments}</div>
                                              </td>
                                              <td class="py-2 px-4">
                                                  <button class="edit-task px-2 py-1 rounded" data-id="${task.id}">
                                                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="pointer-events-none" viewBox="0 0 16 16">
                                                          <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.5.5 0 0 1-.5-.5V9h-.5a.5.5 0 0 1-.5-.5v-.207l.106-.106z"/>
                                                      </svg>
                                                  </button>
                                                  <button class="delete-task px-2 py-1 rounded" data-id="${task.id}">
                                                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="pointer-events-none" viewBox="0 0 16 16">
                                                          <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                                          <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                                      </svg>
                                                  </button>
                                              </td>
                                          `;

                                    taskTableBody.appendChild(row);
                                });

                                // Set up edit and delete buttons
                                document.querySelectorAll('.edit-task').forEach(button => {
                                    button.addEventListener('click', editTask);
                                });

                                document.querySelectorAll('.delete-task').forEach(button => {
                                    button.addEventListener('click', deleteTask);
                                });
                            }

                            // Update sort indicators
                            function updateSortIndicators() {
                                // Clear all indicators
                                document.querySelectorAll('.sort-indicator').forEach(indicator => {
                                    indicator.textContent = '';
                                });

                                // Set current indicator
                                const indicator = document.getElementById(`${currentSort.column}-indicator`);
                                if (indicator) {
                                    indicator.textContent = currentSort.direction === 'asc' ? '▲' : '▼';
                                }
                            }

                            // Setup project filters
                            function setupProjectFilters() {
                                // Get unique projects
                                const projects = [...new Set(tasks.map(task => task.project))];

                                // Clear existing filters (except 'All')
                                while (projectFilters.children.length > 1) {
                                    projectFilters.removeChild(projectFilters.lastChild);
                                }

                                // Add filter buttons for each project
                                projects.forEach(project => {
                                    const button = document.createElement('button');
                                    button.className = 'bg-gray-300 hover:bg-blue-400 text-gray-800 px-3 py-1 w-full';
                                    button.setAttribute('data-project', project);
                                    button.textContent = project;
                                    button.addEventListener('click', filterByProject);
                                    projectFilters.appendChild(button);
                                });

                                // Highlight active filter
                                updateActiveFilter();
                            }

                            // Filter tasks by project
                            function filterByProject(e) {
                                currentFilter = e.target.getAttribute('data-project');
                                localStorage.setItem("last_selected_project", currentFilter);
                                updateActiveFilter();
                                document.getElementById("current-menu").innerText = sessionStorage.getItem("activeMenuHeader") + " - " + currentFilter;
                            }

                            // Update active filter button and refresh
                            function updateActiveFilter() {
                                document.querySelectorAll('#project-filters button').forEach(button => {
                                    const project = button.getAttribute('data-project');
                                    if (project === currentFilter) {
                                        button.classList.remove('bg-gray-300');
                                        button.classList.add('bg-blue-500', 'text-white');
                                        // Update grids
                                        renderTasks();
                                        renderTaskGrid();
                                        loadGanttChart();
                                    } else {
                                        button.classList.remove('bg-blue-500', 'text-white');
                                        button.classList.add('bg-gray-300');
                                    }
                                });
                            }

                            // Set up sortable table
                            function setupSortableTable() {
                                // Set up column sorting
                                const headers = document.querySelectorAll('th[data-sort]');

                                headers.forEach(header => {
                                    header.addEventListener('click', () => {
                                        const column = header.getAttribute('data-sort');

                                        // Toggle direction if clicking the same column
                                        if (currentSort.column === column) {
                                            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                                        } else {
                                            currentSort.column = column;
                                            currentSort.direction = 'asc';
                                        }

                                        renderTasks();
                                    });
                                });

                                // Set up drag and drop with a grab handle
                                new Sortable(taskTableBody, {
                                    animation: 150,
                                    ghostClass: 'bg-gray-200',
                                    handle: '.grab-handle', // Specify the grab handle element
                                    onEnd: function () {
                                        updateTaskUrgency();
                                    }
                                });
                            }

                            // Update task urgency after drag and drop
                            function updateTaskUrgency() {
                                const rows = taskTableBody.querySelectorAll('tr');
                                let urgency = 1;

                                // Create a map of new urgency values
                                const urgencyUpdates = {};
                                rows.forEach(row => {
                                    const id = parseInt(row.getAttribute('data-id'));
                                    urgencyUpdates[id] = urgency++;
                                });

                                // Update the tasks array
                                tasks.forEach(task => {
                                    if (urgencyUpdates[task.id] !== undefined) {
                                        task.urgency = urgencyUpdates[task.id];
                                    }
                                });

                                // Save to localStorage
                                saveTasksToStorage();

                                // Re-render to update displayed urgency numbers
                                renderTasks();
                            }

                            // Setup event listeners
                            function setupEventListeners() {
                                // Add task button
                                addTaskBtn.addEventListener('click', () => {
                                    modalTitle.textContent = 'Add New Task';
                                    document.getElementById('edit-task-id').value = '';
                                    document.getElementById('edit-urgency').value = tasks.length + 1;
                                    // Prepopulate project field from localStorage
                                    const lastSelectedProject = localStorage.getItem('last_selected_project') || '';
                                    document.getElementById('edit-project').value = lastSelectedProject;

                                    // Set start date to today
                                    const today = new Date().toISOString().split('T')[0];
                                    document.getElementById('edit-startdate').value = today;
                                    document.querySelectorAll('input[name="status"]').forEach(radio => radio.checked = false);
                                    document.getElementById('edit-ticket').value = '';

                                    document.getElementById('edit-duedate').value = '';
                                    document.getElementById('edit-enddate').value = '';
                                    document.getElementById('edit-resource').value = '';
                                    document.getElementById('edit-comments').value = '';

                                    editModal.classList.remove('hidden');
                                });

                                // Cancel edit button
                                cancelEditBtn.addEventListener('click', () => {
                                    editModal.classList.add('hidden');
                                });

                                // Form save submission
                                taskForm.addEventListener('submit', function (e) {
                                    e.preventDefault();

                                    const taskId = document.getElementById('edit-task-id').value;
                                    const urgency = parseInt(document.getElementById('edit-urgency').value);
                                    const project = document.getElementById('edit-project').value;
                                    const newProject = document.getElementById('edit-project').value;
                                    const status = document.querySelector('input[name="status"]:checked')?.value || 'amber';
                                    const ticket = document.getElementById('edit-ticket').value;
                                    const startdate = document.getElementById('edit-startdate').value;
                                    const duedate = document.getElementById('edit-duedate').value;
                                    const enddate = document.getElementById('edit-enddate').value;
                                    const resource = document.getElementById('edit-resource').value;
                                    const comments = document.getElementById('edit-comments').value;

                                    if (taskId) {
                                        // Update existing task
                                        const task = tasks.find(t => t.id === parseInt(taskId));
                                        if (task) {
                                            const oldProject = task.project;
                                            task.project = newProject;
                                            task.status = status;
                                            task.ticket = ticket;
                                            task.startdate = startdate;
                                            task.duedate = duedate;
                                            task.enddate = enddate;
                                            task.resource = resource;
                                            task.comments = comments;

                                            // Update all matching project names in the tasks array
                                            tasks.forEach(t => {
                                                if (t.project === oldProject) {
                                                    t.project = newProject;
                                                }
                                            });
                                        }
                                    } else {
                                        // Add new task
                                        const newId = tasks.length > 0 ? Math.max(...tasks.map(t => t.id)) + 1 : 1;
                                        tasks.push({
                                            id: newId,
                                            urgency,
                                            project,
                                            status,
                                            ticket,
                                            startdate,
                                            duedate,
                                            enddate,
                                            resource,
                                            comments
                                        });
                                    }

                                    // Save to localStorage
                                    saveTasksToStorage();

                                    // Store last selected project safely
                                    const lastProject = taskId ? tasks.find(t => t.id === parseInt(taskId))?.project : project;
                                    localStorage.setItem('last_selected_project', lastProject);

                                   // editModal.classList.add('hidden');
                                   // setupProjectFilters(); // Refresh project filters
                                   // renderTasks();

                                    // Reload window to reset to localstorage
                                    window.location.reload();
                                });
                            }

                            // Edit task handler
                            function editTask(e) {
                                const taskId = parseInt(e.target.getAttribute('data-id'));
                                const task = tasks.find(t => t.id === taskId);

                                if (task) {
                                    modalTitle.textContent = 'Edit Task';
                                    document.getElementById('edit-task-id').value = task.id;
                                    document.getElementById('edit-urgency').value = task.urgency;
                                    document.getElementById('edit-project').value = task.project;

                                    document.querySelectorAll('input[name="status"]').forEach(radio => {
                                        radio.checked = radio.value === task.status;
                                    });

                                    document.getElementById('edit-ticket').value = task.ticket;
                                    document.getElementById('edit-startdate').value = task.startdate;
                                    document.getElementById('edit-duedate').value = task.duedate;
                                    document.getElementById('edit-enddate').value = task.enddate;
                                    document.getElementById('edit-resource').value = task.resource;
                                    document.getElementById('edit-comments').value = task.comments;

                                    editModal.classList.remove('hidden');
                                }
                            }

                            // Delete task handler
                            function deleteTask(e) {
                                const taskId = parseInt(e.target.getAttribute('data-id'));

                                if (confirm('Are you sure you want to delete this task?')) {
                                    tasks = tasks.filter(t => t.id !== taskId);

                                    // Save to localStorage
                                    saveTasksToStorage();

                                   // renderTasks();
                                   // setupProjectFilters(); // Refresh project filters in case we removed the last of a project
                                   // updateTaskUrgency(); // Renumber urgency after deletion

                                    window.location.reload();
                                }
                            }

                            // Helper function to get status color class
                            function getStatusColor(status) {
                                switch (status) {
                                    case 'red': return 'bg-red-600';
                                    case 'amber': return 'bg-yellow-500';
                                    case 'green': return 'bg-green-500';
                                    default: return 'bg-gray-400';
                                }
                            }

                            // Helper function to capitalize first letter
                            function capitalizeFirstLetter(string) {
                                return string.charAt(0).toUpperCase() + string.slice(1);
                            }

                            // Helper function to format dates
                            function formatDate(dateString) {
                                if (!dateString) return '';

                                const date = new Date(dateString);
                                return date.toLocaleDateString();
                            }
                        </script>
                    </div>

                </div>
                <!-- Gantt Area -->
                <div id="gantt" class="content hidden">

                    <div class="p-4">
                        <div id="project-buttons" class="flex flex-wrap gap-2 mb-4"></div>
                        <div class="overflow-x-auto">
                            <div id="gantt-grid" class="flex flex-col border border-gray-300 min-w-max"></div>
                        </div>

                        <script>
                            const ppmsTasks = JSON.parse(localStorage.getItem('ppms_tasks')) || [];
                            const lastSelectedProject = localStorage.getItem('last_selected_project');

                            if (!ppmsTasks.length) {
                                console.log('No tasks found in localStorage. Initializing with an empty array.');
                            }

                            const formatWeekRange = (startDate, endDate) => {
                                const startMonth = startDate.toLocaleString('default', { month: 'short' });
                                const startDay = startDate.getDate();
                                const endDay = endDate.getDate();
                                return `${startMonth} ${startDay}-${endDay}`;
                            };

                            const formatDayOfWeek = (day) => {
                                const days = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
                                return days[day];
                            };

                            const isWeekend = (day) => {
                                return day === 0 || day === 6; // Sunday (0) or Saturday (6)
                            };

                            const calculateWeeksRange = (tasks) => {
                                let earliestStart = Infinity;
                                let latestEnd = -Infinity;

                                tasks.forEach(task => {
                                    const startDate = new Date(task.startdate);
                                    const endDate = new Date(task.enddate || task.duedate);

                                    if (startDate < earliestStart) earliestStart = startDate;
                                    if (endDate > latestEnd) latestEnd = endDate;
                                });

                                if (earliestStart === Infinity || latestEnd === -Infinity) {
                                    const now = new Date();
                                    earliestStart = new Date(now.getFullYear(), 0, 1);
                                    latestEnd = new Date(now.getFullYear(), 11, 31);
                                }

                                const weeks = [];
                                let currentWeekStart = new Date(earliestStart);
                                currentWeekStart.setDate(currentWeekStart.getDate() - currentWeekStart.getDay());

                                while (currentWeekStart <= latestEnd) {
                                    const currentWeekEnd = new Date(currentWeekStart);
                                    currentWeekEnd.setDate(currentWeekEnd.getDate() + 6);
                                    weeks.push({ start: new Date(currentWeekStart), end: new Date(currentWeekEnd) });
                                    currentWeekStart.setDate(currentWeekStart.getDate() + 7);
                                }
                                return weeks;
                            };

                            const getDaysBetweenDates = (startDate, endDate) => {
                                const oneDay = 24 * 60 * 60 * 1000; // hours*minutes*seconds*milliseconds
                                const start = new Date(startDate);
                                const end = new Date(endDate);

                                // Set hours to noon to avoid DST issues
                                start.setHours(12, 0, 0, 0);
                                end.setHours(12, 0, 0, 0);

                                const diffDays = Math.round(Math.abs((end - start) / oneDay)) + 1; // +1 to include the start day
                                return diffDays;
                            };

                            // Function to determine RAG status based on task data
                            const getRAGStatus = (task) => {
                                // If the task has a status property, use it
                                if (task.status) {
                                    const status = task.status.toLowerCase();
                                    if (status.includes('red')) return 'red';
                                    if (status.includes('amber') || status.includes('yellow')) return 'amber';
                                    if (status.includes('green')) return 'green';
                                }

                                // Otherwise determine based on task dates
                                const now = new Date();
                                const startDate = new Date(task.startdate);
                                const endDate = new Date(task.enddate || task.duedate);

                                // Task completed or not yet started
                                if (endDate < now) return 'green';
                                if (startDate > now) return 'green';

                                // Task in progress
                                const totalDays = getDaysBetweenDates(startDate, endDate);
                                const daysElapsed = getDaysBetweenDates(startDate, now);
                                const percentComplete = (daysElapsed / totalDays) * 100;

                                // Simple heuristic: if we've used more than 80% of the time, it's red
                                // if we've used more than 50% of the time, it's amber
                                if (percentComplete > 80) return 'red';
                                if (percentComplete > 50) return 'amber';
                                return 'green';
                            };

                            // Function to get RAG color classes
                            const getRAGColorClass = (status) => {
                                switch (status) {
                                    case 'red':
                                        return 'bg-red-100';
                                    case 'amber':
                                        return 'bg-amber-100';
                                    case 'green':
                                        return 'bg-green-100';
                                    default:
                                        return '';
                                }
                            };

                            // Function to get RAG flag indicator
                            const getRAGFlagIndicator = (status) => {
                                switch (status) {
                                    case 'red':
                                        return '<span class="inline-block w-4 h-4 bg-red-500 rounded-full"></span>';
                                    case 'amber':
                                        return '<span class="inline-block w-4 h-4 bg-amber-500 rounded-full"></span>';
                                    case 'green':
                                        return '<span class="inline-block w-4 h-4 bg-green-500 rounded-full"></span>';
                                    default:
                                        return '';
                                }
                            };

                            const ganttGrid = document.getElementById('gantt-grid');

                            const renderGridHeaders = (weeks) => {
                                ganttGrid.innerHTML = '';

                                // Year header row
                                const yearHeaderRow = document.createElement('div');
                                yearHeaderRow.className = 'flex border-b border-gray-300 bg-gray-100 font-bold';

                                const emptyCell1 = document.createElement('div');
                                emptyCell1.className = 'w-32 p-2 text-center border-r border-gray-300 flex-shrink-0';
                                yearHeaderRow.appendChild(emptyCell1);

                                const statusCell = document.createElement('div');
                                statusCell.className = 'w-16 p-2 text-center border-r border-gray-300 flex-shrink-0';
                                yearHeaderRow.appendChild(statusCell);

                                const emptyCell2 = document.createElement('div');
                                emptyCell2.className = 'w-32 p-2 text-center border-r border-gray-300 flex-shrink-0';
                                yearHeaderRow.appendChild(emptyCell2);

                                const daysCell = document.createElement('div');
                                daysCell.className = 'w-20 p-2 text-center border-r border-gray-300 flex-shrink-0';
                                yearHeaderRow.appendChild(daysCell);

                                weeks.forEach(week => {
                                    const yearCell = document.createElement('div');
                                    yearCell.className = 'w-56 p-2 text-center border-r border-gray-300 flex-shrink-0';
                                    yearCell.textContent = week.start.getFullYear();
                                    yearHeaderRow.appendChild(yearCell);
                                });

                                ganttGrid.appendChild(yearHeaderRow);

                                // Week header row
                                const weekHeaderRow = document.createElement('div');
                                weekHeaderRow.className = 'flex border-b border-gray-300 bg-gray-100 font-bold';

                                const resourceHeader = document.createElement('div');
                                resourceHeader.className = 'w-32 p-2 text-center border-r border-gray-300 flex-shrink-0';
                                resourceHeader.textContent = 'Resource';
                                weekHeaderRow.appendChild(resourceHeader);

                                const statusHeader = document.createElement('div');
                                statusHeader.className = 'w-16 p-2 text-center border-r border-gray-300 flex-shrink-0';
                                statusHeader.textContent = 'Status';
                                weekHeaderRow.appendChild(statusHeader);

                                const ticketHeader = document.createElement('div');
                                ticketHeader.className = 'w-32 p-2 text-center border-r border-gray-300 flex-shrink-0';
                                ticketHeader.textContent = 'Ticket';
                                weekHeaderRow.appendChild(ticketHeader);

                                const daysHeader = document.createElement('div');
                                daysHeader.className = 'w-20 p-2 text-center border-r border-gray-300 flex-shrink-0';
                                daysHeader.textContent = 'Days';
                                weekHeaderRow.appendChild(daysHeader);

                                weeks.forEach(week => {
                                    const weekCell = document.createElement('div');
                                    weekCell.className = 'w-56 p-2 text-center border-r border-gray-300 flex-shrink-0 flex';
                                    weekCell.textContent = formatWeekRange(week.start, week.end);
                                    weekHeaderRow.appendChild(weekCell);
                                });

                                ganttGrid.appendChild(weekHeaderRow);

                                // Day of week header row
                                const dayHeaderRow = document.createElement('div');
                                dayHeaderRow.className = 'flex border-b border-gray-300 bg-gray-100';

                                const emptyResourceCell = document.createElement('div');
                                emptyResourceCell.className = 'w-32 p-2 text-center border-r border-gray-300 flex-shrink-0';
                                dayHeaderRow.appendChild(emptyResourceCell);

                                const emptyStatusCell = document.createElement('div');
                                emptyStatusCell.className = 'w-16 p-2 text-center border-r border-gray-300 flex-shrink-0';
                                dayHeaderRow.appendChild(emptyStatusCell);

                                const emptyTicketCell = document.createElement('div');
                                emptyTicketCell.className = 'w-32 p-2 text-center border-r border-gray-300 flex-shrink-0';
                                dayHeaderRow.appendChild(emptyTicketCell);

                                const emptyDaysCell = document.createElement('div');
                                emptyDaysCell.className = 'w-20 p-2 text-center border-r border-gray-300 flex-shrink-0';
                                dayHeaderRow.appendChild(emptyDaysCell);

                                weeks.forEach(week => {
                                    const dayContainer = document.createElement('div');
                                    dayContainer.className = 'flex w-56 flex-shrink-0 border-r border-gray-300';

                                    for (let i = 0; i < 7; i++) {
                                        const currentDay = new Date(week.start);
                                        currentDay.setDate(currentDay.getDate() + i);

                                        const dayCell = document.createElement('div');
                                        dayCell.className = 'w-8 p-1 text-center flex-1 font-bold';

                                        // Add gray background for weekend days
                                        if (isWeekend(i)) {
                                            dayCell.className += ' bg-gray-200';
                                        }

                                        dayCell.textContent = formatDayOfWeek(i);
                                        dayContainer.appendChild(dayCell);
                                    }

                                    dayHeaderRow.appendChild(dayContainer);
                                });

                                ganttGrid.appendChild(dayHeaderRow);
                            };

                            const filterTasksByProject = (project) => {
                                const filteredTasks = ppmsTasks.filter(task => task.project === project);
                                ganttGrid.innerHTML = ''; // Clear previous grid

                                if (!filteredTasks.length) {
                                    ganttGrid.innerHTML = '<p class="p-4">No tasks found for this project.</p>';
                                    return;
                                }

                                const weeks = calculateWeeksRange(filteredTasks);
                                renderGridHeaders(weeks);

                                filteredTasks.forEach(task => {
                                    const ragStatus = getRAGStatus(task);
                                    const ragColorClass = getRAGColorClass(ragStatus);

                                    const taskRow = document.createElement('div');
                                    taskRow.className = `flex border-b border-gray-300 ${ragColorClass}`;

                                    const resourceCell = document.createElement('div');
                                    resourceCell.className = 'w-32 p-2 text-center border-r border-gray-300 flex-shrink-0';
                                    resourceCell.textContent = task.resource;
                                    taskRow.appendChild(resourceCell);

                                    const statusCell = document.createElement('div');
                                    statusCell.className = 'w-16 p-2 text-center border-r border-gray-300 flex-shrink-0';
                                    statusCell.innerHTML = getRAGFlagIndicator(ragStatus);
                                    taskRow.appendChild(statusCell);

                                    const ticketCell = document.createElement('div');
                                    ticketCell.className = 'w-32 p-2 text-center border-r border-gray-300 flex-shrink-0';
                                    ticketCell.textContent = task.ticket;
                                    taskRow.appendChild(ticketCell);

                                    const startDate = new Date(task.startdate);
                                    const endDate = new Date(task.enddate || task.duedate);

                                    const daysCell = document.createElement('div');
                                    daysCell.className = 'w-20 p-2 text-center border-r border-gray-300 flex-shrink-0';
                                    daysCell.textContent = getDaysBetweenDates(startDate, endDate);
                                    taskRow.appendChild(daysCell);

                                    weeks.forEach(week => {
                                        const weekContainer = document.createElement('div');
                                        weekContainer.className = 'flex w-56 flex-shrink-0 border-r border-gray-300';

                                        for (let i = 0; i < 7; i++) {
                                            const currentDay = new Date(week.start);
                                            currentDay.setDate(currentDay.getDate() + i);

                                            const dayCell = document.createElement('div');
                                            dayCell.className = 'w-8 p-1 text-center flex-1';

                                            // Add gray background for weekend days
                                            if (isWeekend(i)) {
                                                dayCell.className += ' bg-gray-200';
                                            }

                                            // Check if this day falls within the task's date range
                                            if (currentDay >= startDate && currentDay <= endDate) {
                                                dayCell.className += ' bg-blue-200';

                                                // If this is a weekend day within the task range, use a different color
                                                if (isWeekend(i)) {
                                                    dayCell.className = dayCell.className.replace('bg-gray-200', '').replace('bg-blue-200', '');
                                                    dayCell.className += ' bg-blue-100';
                                                }
                                            }

                                            weekContainer.appendChild(dayCell);
                                        }

                                        taskRow.appendChild(weekContainer);
                                    });

                                    ganttGrid.appendChild(taskRow);
                                });
                            };

                            // New function that can be called by an external button
                            function loadGanttChart() {
                                // Get the last selected project from localStorage
                                const project = localStorage.getItem('last_selected_project');

                                if (project) {
                                    // Apply the filter with the retrieved project
                                    filterTasksByProject(project);
                                    console.log(`Loaded Gantt chart for project: ${project}`);
                                } else {
                                    // If no project is stored, try to find a default one
                                    if (ppmsTasks.length > 0) {
                                        // Get all unique projects
                                        const projects = [...new Set(ppmsTasks.map(task => task.project))];
                                        if (projects.length > 0) {
                                            const firstProject = projects[0];
                                            // Save this as the last selected project
                                            localStorage.setItem('last_selected_project', firstProject);
                                            filterTasksByProject(firstProject);
                                            console.log(`No last selected project found. Defaulting to: ${firstProject}`);
                                        }
                                    } else {
                                        // If no tasks exist, just show an empty grid
                                        const weeks = calculateWeeksRange([]);
                                        renderGridHeaders(weeks);
                                        console.log('No tasks found. Showing empty Gantt chart.');
                                    }
                                }
                            }

                            // Initialize the chart when the script loads (optional)
                            // Comment this out if you only want it to load when the button is clicked
                            loadGanttChart();
                        </script>
                    </div>

                </div>
                <!-- KanBan Area -->
                <div id="kanban" class="content hidden">

                    <div class="min-h-screen p-4">
                        <!-- Columns -->
                        <div class="w-full max-w-4xl flex justify-center items-center">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <!-- Red Column -->
                                <div id="red-column" class="bg-red-500 p-3 rounded-lg flex flex-col gap-2"
                                     ondrop="drop(event, 'red')" ondragover="allowDrop(event)">
                                    <h2 class="text-white">Red</h2>
                                    <div id="red-cells" class="flex flex-col gap-2"></div>
                                </div>

                                <!-- Amber Column -->
                                <div id="amber-column" class="bg-amber-500 p-3 rounded-lg flex flex-col gap-2"
                                     ondrop="drop(event, 'amber')" ondragover="allowDrop(event)">
                                    <h2 class="text-white">Amber</h2>
                                    <div id="amber-cells" class="flex flex-col gap-2"></div>
                                </div>

                                <!-- Green Column -->
                                <div id="green-column" class="bg-green-500 p-3 rounded-lg flex flex-col gap-2"
                                     ondrop="drop(event, 'green')" ondragover="allowDrop(event)">
                                    <h2 class="text-white">Green</h2>
                                    <div id="green-cells" class="flex flex-col gap-2"></div>
                                </div>
                            </div>
                        </div>

                        <script>
                            // Retrieve tasks from localStorage
                            let kbtasks = JSON.parse(localStorage.getItem("ppms_tasks")) || [];

                            // Initialize the grid with tasks on page load
                            window.onload = function () {
                                renderTaskGrid();
                            };

                            // Reusable function to render the task grid
                            function renderTaskGrid() {
                                // Clear existing tasks from the grid
                                document.getElementById("red-cells").innerHTML = "";
                                document.getElementById("amber-cells").innerHTML = "";
                                document.getElementById("green-cells").innerHTML = "";

                                // Load tasks and apply the filter
                                loadTasks();

                                // Get the selected project from localStorage
                                const selectedProject = localStorage.getItem("last_selected_project") || "all";
                                console.log("Filter applied:", selectedProject);
                                filterTasks(selectedProject);
                            }

                            function allowDrop(event) {
                                event.preventDefault();
                            }

                            function drag(event) {
                                event.dataTransfer.setData("text", event.target.id);
                            }

                            function drop(event, column) {
                                event.preventDefault();
                                const id = event.dataTransfer.getData("text");
                                const draggedElement = document.getElementById(id);
                                document.getElementById(`${column}-cells`).appendChild(draggedElement);
                                updateTaskColumn(id, column);
                            }

                            function createTaskElement(task) {
                                const { id, project, resource, comments, status } = task;
                                const taskDiv = document.createElement("div");
                                taskDiv.classList.add("p-2", "rounded", "bg-white", "shadow-lg", "draggable", "flex", "flex-col", "gap-2");
                                taskDiv.setAttribute("id", id);
                                taskDiv.setAttribute("draggable", "true");
                                taskDiv.setAttribute("ondragstart", "drag(event)");

                                const projectText = document.createElement("div");
                                projectText.classList.add("text-sm", "font-bold");
                                projectText.textContent = `Project: ${project}`;

                                const resourceText = document.createElement("div");
                                resourceText.classList.add("text-sm");
                                resourceText.textContent = `Resource: ${resource}`;

                                const commentsText = document.createElement("input");
                                commentsText.type = "text";
                                commentsText.classList.add("w-full", "p-2", "rounded", "text-black", "border");
                                commentsText.value = comments;
                                commentsText.placeholder = "Enter task details";
                                commentsText.addEventListener("input", () => updateTaskComments(id, commentsText.value));

                                taskDiv.appendChild(projectText);
                                taskDiv.appendChild(resourceText);
                                taskDiv.appendChild(commentsText);

                                return taskDiv;
                            }

                            function loadTasks() {
                                kbtasks.forEach(task => {
                                    const taskElement = createTaskElement(task);
                                    const columnId = `${task.status}-cells`;
                                    const column = document.getElementById(columnId);
                                    if (column) {
                                        column.appendChild(taskElement);
                                    }
                                });
                            }

                            function updateTaskColumn(taskId, newColumn) {
                                const task = kbtasks.find(t => t.id == taskId);
                                if (task) {
                                    task.status = newColumn;
                                    saveToLocalStorage();
                                }
                            }

                            function updateTaskComments(taskId, newComments) {
                                const task = kbtasks.find(t => t.id == taskId);
                                if (task) {
                                    task.comments = newComments;
                                    saveToLocalStorage();
                                }
                            }

                            function saveToLocalStorage() {
                                localStorage.setItem("ppms_tasks", JSON.stringify(kbtasks));
                            }

                            // Filter tasks by project
                            function filterTasks(project) {
                                const allTasks = document.querySelectorAll(".draggable");
                                console.log("Filtering tasks for project:", project);
                                allTasks.forEach(task => {
                                    const taskProject = kbtasks.find(t => t.id == task.id)?.project;
                                    console.log("Task project:", taskProject);
                                    if (project === "all" || taskProject === project) {
                                        task.style.display = "flex";
                                    } else {
                                        task.style.display = "none";
                                    }
                                });
                            }
                        </script>
                    </div>


                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            console.log("DOMContentLoaded event fired.");

            const menuItems = document.querySelectorAll(".menu-item");
            console.log("Found menu items:", menuItems);

            const contents = document.querySelectorAll(".content");
            console.log("Found content sections:", contents);

            let activeMenu = sessionStorage.getItem("activeMenu") || "project";

            console.log("Active menu from sessionStorage:", activeMenu);

            function showContent(target) {
                console.log(`Switching content to: ${target}`);

                contents.forEach(div => {
                    div.classList.add("hidden");
                    console.log(`Hiding content: ${div.id}`);
                });

                const targetContent = document.getElementById(target);
                if (targetContent) {
                    targetContent.classList.remove("hidden");
                    console.log(`Showing content: ${target}`);
                } else {
                    console.warn(`Element with ID '${target}' not found.`);
                }

                menuItems.forEach(item => {
                    item.classList.remove("bg-gray-200");
                    console.log(`Removing bg-gray-200 from: ${item.dataset.target}`);
                });

                const targetMenuItem = document.querySelector(`[data-target='${target}']`);
                if (targetMenuItem) {
                    targetMenuItem.classList.add("bg-gray-200");
                    console.log(`Adding bg-gray-200 to: ${target}`);
                } else {
                    console.warn(`Menu item with data-target '${target}' not found.`);
                }

                sessionStorage.setItem("activeMenu", target);

                let activeMenu = sessionStorage.getItem("activeMenu") || "project";
                let currentProject = localStorage.getItem("last_selected_project");
                if (target === "gantt") target = "Gantt";
                if (target === "project") target = "Project";
                if (target === "kanban") target = "KanBan";
                sessionStorage.setItem("activeMenuHeader", target);
                console.log(`Updated sessionStorage: activeMenuHeader = ${target}`);

                // Show as header
                document.getElementById("current-menu").innerText = target + " - " + currentProject;


                if (target === "kanban" && typeof renderTaskGrid === "function") {
                    console.log("Calling renderTaskGrid()");
                    renderTaskGrid();
                }
            }

            menuItems.forEach(item => {
                console.log(`Adding click event listener to: ${item.dataset.target}`);
                item.addEventListener("click", function () {
                    console.log(`Clicked on: ${this.dataset.target}`);
                    showContent(this.dataset.target);
                });
            });

            console.log("Initializing with activeMenu:", activeMenu);
            showContent(activeMenu);
        });
    </script>
</body>

</html>